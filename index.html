<!DOCTYPE html>
<html>
<head>
    <title>Title of the document</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="description" content = "">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        body, html {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: #666;
        }
        #myCanvas {
            position: relative;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);    
            border: solid 1px #000;
            background: #fff;
        }
        #fps {
            position: absolute;
            bottom: 10px;
            left: 50%;
            -webkit-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            transform: translateX(-50%);   
            font-family: sans-serif;
            font-size: 0.8em;
            color: #ddd;
        }
    </style>
</head>
<body>
    <canvas id="myCanvas" width="1000" height="400"></canvas>
    <div id="fps"></div>
    <script>
    var FpsShow = function () {
        this.lastLoop = 0;
        this.thisLoop = 0;
        this.fps = 0;
    };

    FpsShow.prototype.render = function () {
        this.thisLoop = (new Date()).getTime();
        this.fps = 1000 / (this.thisLoop - this.lastLoop);
        this.lastLoop = this.thisLoop;
        document.getElementById('fps').innerHTML = "FPS: " + Math.round(this.fps);
    };

    var Canvas = function () {
        this.canvas = document.getElementById('myCanvas');
        this.context = this.canvas.getContext('2d');
    };

    Canvas.prototype.clean = function () {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    };

    var Keyboard = function () {
        this.keyMap = { 37: false, 38: false, 39: false, 40: false, 32: false, 17: false };
        this.keyMapMemLR = { 37: false, 39: false };
    };

    Keyboard.prototype.kDown = function (e) {
        this.keyMap[e.keyCode] = true;
        this.saveToMem(); // to decide which direction to fire    
    };

    Keyboard.prototype.kUp = function (e) {
        this.keyMap[e.keyCode] = false;
        this.saveToMem(); // to decide which direction to fire
    };

    Keyboard.prototype.saveToMem = function () { // save history of lefr / right key 
        if (this.keyMap[37] == true) {
            this.keyMapMemLR[37] = true;
            this.keyMapMemLR[39] = false;
        }
        if (this.keyMap[39] == true) {
            this.keyMapMemLR[37] = false;
            this.keyMapMemLR[39] = true;
        }
    };

    var Animal = function (canvas, allWeapons) {
        this.animalWidth = 20;
        this.animalHeight = 20;
        this.weapons = allWeapons;
        this.canvas = canvas.canvas;
        this.context = canvas.context;
        this.fpsTiming = (new Date()).getTime();
        this.speed = 130; // speed (px / s)
        this.jumpSpeed = 700;
        this.x = 10; // start position x
        this.y = this.canvas.height - this.animalHeight; // start position y
        this.jumping = false; // false - not in jump | true - in jump
        this.jumpStartTime = 0; // jump timing - for gravity to calculate actual speed of the jump
    };

    Animal.prototype.calculateSpeed = function () { // left / right moving (px / s | respecting fps )
        var time = 0, pixels = 0;

        time = (new Date()).getTime() - this.fpsTiming; // timing begin
        pixels = Math.round(this.speed * time / 1000);
        return pixels;
    };

    Animal.prototype.jump = function () {
        var pixels = 0, spd = 0, time = 0;

        if (this.jumping == false && this.jumpInic == false) { // no jumping / no jump initialization
            return;
        }

        if (this.jumpInic == true && this.jumping == false) { // no jumping / jump inic
            this.jumping = true;
            this.jumpStartTime = (new Date()).getTime();
        }

        if (this.jumping == true) { // calculate jump speed
            spd = this.jumpSpeed - (((new Date()).getTime() - this.jumpStartTime) * 2.81); // (jumpspeed) - ((now) - (jump start)) * gravity acceleration

            time = (new Date()).getTime() - this.fpsTiming;
            pixels = Math.round(spd * time / 1000);  

            this.y -= pixels;
        }

        if (this.y >= this.canvas.height - this.animalHeight) { // TO DO - set floor for objects
            this.jumping = false;
        }
        this.jumpInic = false;
    };

    Animal.prototype.render = function (keyMap, keyMapMemLR) {
        var left = keyMap[37];
        var up = keyMap[38] || keyMap[32];
        var right = keyMap[39];
        var down = keyMap[40];

        var pixels = this.calculateSpeed(); // move left right

        if (left)   this.x -= pixels;
        if (right)  this.x += pixels;
        if (up)     this.jumpInic = true;
    
        this.jump();
    
        if (keyMap[17] == true) { // create new weapon
            this.weapons.create(this.x, this.y, this.animalWidth, this.animalHeight, keyMapMemLR);
        }

        if (this.x < 0) this.x = 0;
        if (this.y < 0) this.y = 0; 
        if (this.x > this.canvas.width  - this.animalWidth) this.x = this.canvas.width  - this.animalWidth;
        if (this.y > this.canvas.height - this.animalHeight) this.y = this.canvas.height - this.animalHeight;   

        this.context.beginPath();
        this.context.rect(this.x, this.y, this.animalWidth, this.animalHeight);
        this.context.fillStyle = 'yellow';
        this.context.fill();
        this.context.lineWidth = 2;
        this.context.strokeStyle = 'black';
        this.context.stroke();

        this.fpsTiming = (new Date()).getTime();
    };

    var Weapon = function (canvas, x, y, right_left) {
        this.canvas = canvas.canvas;
        this.context = canvas.context;
        this.fpsTiming = (new Date()).getTime();
        this.speed = 400; // px / s
        this.x = x;
        this.y = y;
        this.size = 2;
        this.deleteMe = false;
        this.fire_right_left = right_left; 
    };

    Weapon.prototype.render = function () {
        if (this.fire_right_left == 1)
            this.fireLeft();
        else
            this.fireRight();

        this.context.beginPath();
        this.context.moveTo(this.x, this.y);
        this.context.lineTo(this.x + this.size, this.y);
        this.context.lineWidth = 2;
        this.context.strokeStyle = '#990000';
        this.context.stroke();

        this.fpsTiming = (new Date()).getTime();
    };

    Weapon.prototype.fireLeft = function () {
        var pixels = this.calculateSpeed();
        this.x -= pixels;
        if (this.x <= 0) {
            this.deleteMe = true;
        }
    };

    Weapon.prototype.fireRight = function () {
        var pixels = this.calculateSpeed();
        this.x += pixels;
        if (this.x > this.canvas.width) {
            this.deleteMe = true;
        }
    }

    Weapon.prototype.calculateSpeed = function () {
        var time = 0, pixels = 0;
        time = (new Date()).getTime() - this.fpsTiming;
        pixels = Math.round(this.speed * time / 1000);
        return pixels;
    };

    var AllWeapons = function (canvas) {
        this.canvas = canvas;
        this.weapons = new Array();
    };

    AllWeapons.prototype.create = function (x, y, width, height, keyMapMemLR) {
        var w_x, w_y, right_left;
        if (keyMapMemLR[37] == true) { // fire to left
            w_x = x - 2;
            w_y = y + (height / 2) - 1; // -1 px (height of the fire)
            right_left = 1;
        } else { // fire to right
            w_x = x + width;
            w_y = y + (height / 2) - 1; // -1 px (height of the fire)
            right_left = 2;
        }

        var w = new Weapon(this.canvas, w_x, w_y, right_left);
        this.weapons[this.weapons.length] = w;
    };

    AllWeapons.prototype.render = function () {
        this.weapons.forEach( function (e, index) {
            e.render();
            if (e.deleteMe == true) {
                delete this.weapons[index];
            }
        }, this);
    };

    var canvas = new Canvas();
    var fpsShow = new FpsShow();
    var keyboard = new Keyboard();

    document.addEventListener("keydown", function (e) { keyboard.kDown(e); });
    document.addEventListener("keyup", function (e) { keyboard.kUp(e); });

    var allWeapons = new AllWeapons(canvas);
    var animal = new Animal(canvas, allWeapons);

    setInterval( function () {
        fpsShow.render();
        canvas.clean();
        animal.render(keyboard.keyMap, keyboard.keyMapMemLR);
        allWeapons.render();
    }, 20);

    </script>
</body>
</html>
